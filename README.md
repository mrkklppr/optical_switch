# Optical Switch Management Web Application

This repository contains a Flask-based web application and setup script for managing an optical switch via a serial connection. The application includes features like user authentication, secure command handling, and responsive feedback on operations.

## Features
- **User Authentication**: Secure login system using hashed passwords.
- **Optical Switch Management**: Send commands to control ports and turn the switch off.
- **Web Interface**: Simple and user-friendly interface for managing the optical switch.
- **Enhanced Security**:
  - Randomly generated secret key.
  - Secure cookie handling with HTTPS enforcement.
  - Automatic session expiration.
- **Error Handling**: Graceful handling of invalid inputs and unexpected errors.
- **Automated Setup**: A `setup.sh` script for environment configuration and deployment.

## Prerequisites

### Hardware
- A computer with access to the optical switch via a serial connection.

### Software
1. **Python**: Version 3.7 or later.
2. **Dependencies**:
   - Flask
   - Flask-SQLAlchemy
   - Flask-Bcrypt
   - pyserial

   Install the required dependencies by running:
   ```bash
   pip install flask flask-sqlalchemy flask-bcrypt pyserial
   ```
   or
   ```bash
   sudo apt install python3-flask python3-flask-sqlalchemy python3-bcrypt python3-serial
   ```
   
4. **SSL Certificates**:
   - Automatically generated by the `setup.sh` script.

## Setup
1. Clone the repository:
   ```bash
   git clone https://github.com/mrkklppr/optical_switch.git
   cd optical_switch
   ```

2. Run the setup script:
   ```bash
   chmod +x setup.sh
   ./setup.sh
   ```
   The script will:
   - Update the system and install required dependencies.
   - Initialize the database and optionally create users.
   - Generate SSL certificates for HTTPS.
   - Enable the Raspberry Pi serial interface.
   - Configure and start the application as a systemd service.

3. Access the app at `https://<your-ip>:5000`.

## Application Details

### Endpoints
- `/`: Main page for sending commands to the optical switch.
- `/login`: User login page.
- `/logout`: Logs the user out and clears their session.

### Command Execution
- Commands are sent to the optical switch via a serial connection. The valid port range is 1 to 999, or the special command `off` to turn the switch off.

### Security Configuration
- Secure cookies and HTTPS ensure the application is safe for deployment.
- Sessions are limited to 5 minutes of inactivity.
- User credentials are hashed using bcrypt for secure storage.

## Folder Structure
```
/optical_switch
|-- templates
|   |-- index.html  # Main interface
|   |-- login.html  # Login form
|   |-- 404.html    # 404 error page
|   |-- 500.html    # 500 error page
|-- static
|   |-- (CSS/JS files for styling and interactivity)
|-- app.py          # Main application script
|-- setup.sh        # Automated setup script
|-- users.db        # SQLite database (auto-created)
|-- server.crt      # SSL certificate (auto-generated)
|-- server.key      # SSL key (auto-generated)
```

## Limitations
- The application assumes the serial port is `/dev/serial0`. Update `SERIAL_CONFIG` in `app.py` if necessary.
- Error messages for serial communication issues are logged but not displayed in detail for security reasons.

## License
This project is licensed under the MIT License.

---

Feel free to open issues or contribute to this repository!

